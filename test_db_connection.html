<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase DB ì—°ê²° í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success {
            color: #4ade80;
        }
        .error {
            color: #f87171;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Supabase DB ì—°ê²° í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h2>1. ì—°ê²° ì •ë³´</h2>
        <pre id="connection-info"></pre>
    </div>
    
    <div class="test-section">
        <h2>2. ì°¸ê°€ì ë°ì´í„° ì¡°íšŒ</h2>
        <button onclick="testContestants()">ì°¸ê°€ì ì¡°íšŒ í…ŒìŠ¤íŠ¸</button>
        <pre id="contestants-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>3. íˆ¬í‘œ ë°ì´í„° ì¡°íšŒ</h2>
        <button onclick="testVotes()">íˆ¬í‘œ ë°ì´í„° ì¡°íšŒ í…ŒìŠ¤íŠ¸</button>
        <pre id="votes-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>4. íˆ¬í‘œ ìˆ˜ ê³„ì‚°</h2>
        <button onclick="testVoteCount()">íˆ¬í‘œ ìˆ˜ ê³„ì‚° í…ŒìŠ¤íŠ¸</button>
        <pre id="vote-count-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>5. ì¸ì¦ ìƒíƒœ</h2>
        <button onclick="testAuth()">ì¸ì¦ ìƒíƒœ í™•ì¸</button>
        <pre id="auth-result"></pre>
    </div>

    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        const SUPABASE_URL = 'https://gmujzyyvdllvapbphtnw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtdWp6eXl2ZGxsdmFwYnBodG53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NzQ4MDgsImV4cCI6MjA3NTI1MDgwOH0.bwuoIIARm9FayJ2zavqUVIywAIjXDsLVlSkemQAxkY0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ì—°ê²° ì •ë³´ í‘œì‹œ
        document.getElementById('connection-info').innerHTML = 
            `<span class="success">âœ… Supabase URL: ${SUPABASE_URL}</span>\n` +
            `<span class="success">âœ… API Key: ${SUPABASE_KEY.substring(0, 30)}...</span>`;
        
        // ì°¸ê°€ì ë°ì´í„° ì¡°íšŒ
        async function testContestants() {
            const result = document.getElementById('contestants-result');
            result.innerHTML = 'â³ ì¡°íšŒ ì¤‘...';
            
            try {
                const { data, error, count } = await supabase
                    .from('contestants')
                    .select('id, name, song, vote_count, views, likes', { count: 'exact' });
                
                if (error) {
                    result.innerHTML = `<span class="error">âŒ ì—ëŸ¬: ${error.message}</span>\n${JSON.stringify(error, null, 2)}`;
                } else {
                    result.innerHTML = 
                        `<span class="success">âœ… ì„±ê³µ! ${count || data.length}ëª…ì˜ ì°¸ê°€ìë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.</span>\n\n` +
                        JSON.stringify(data, null, 2);
                }
            } catch (err) {
                result.innerHTML = `<span class="error">âŒ ì˜ˆì™¸ ë°œìƒ: ${err.message}</span>`;
            }
        }
        
        // íˆ¬í‘œ ë°ì´í„° ì¡°íšŒ
        async function testVotes() {
            const result = document.getElementById('votes-result');
            result.innerHTML = 'â³ ì¡°íšŒ ì¤‘...';
            
            try {
                const { data, error, count } = await supabase
                    .from('votes')
                    .select('*', { count: 'exact' });
                
                if (error) {
                    result.innerHTML = `<span class="error">âŒ ì—ëŸ¬: ${error.message}</span>\n${JSON.stringify(error, null, 2)}`;
                } else {
                    result.innerHTML = 
                        `<span class="success">âœ… ì„±ê³µ! ì´ ${count || data.length}ê°œì˜ íˆ¬í‘œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.</span>\n\n` +
                        JSON.stringify(data, null, 2);
                }
            } catch (err) {
                result.innerHTML = `<span class="error">âŒ ì˜ˆì™¸ ë°œìƒ: ${err.message}</span>`;
            }
        }
        
        // íˆ¬í‘œ ìˆ˜ ê³„ì‚°
        async function testVoteCount() {
            const result = document.getElementById('vote-count-result');
            result.innerHTML = 'â³ ì¡°íšŒ ì¤‘...';
            
            try {
                // ëª¨ë“  ì°¸ê°€ìì˜ ì‹¤ì œ íˆ¬í‘œ ìˆ˜ ê³„ì‚°
                const { data: contestants, error: contestantsError } = await supabase
                    .from('contestants')
                    .select('id, name, vote_count');
                
                if (contestantsError) throw contestantsError;
                
                const results = [];
                for (const contestant of contestants) {
                    const { count, error } = await supabase
                        .from('votes')
                        .select('*', { count: 'exact', head: true })
                        .eq('contestant_id', contestant.id);
                    
                    results.push({
                        name: contestant.name,
                        vote_count_in_table: contestant.vote_count || 0,
                        actual_vote_count: count || 0,
                        match: (contestant.vote_count || 0) === (count || 0) ? 'âœ…' : 'âŒ'
                    });
                }
                
                result.innerHTML = 
                    `<span class="success">âœ… íˆ¬í‘œ ìˆ˜ ê³„ì‚° ì™„ë£Œ</span>\n\n` +
                    JSON.stringify(results, null, 2);
            } catch (err) {
                result.innerHTML = `<span class="error">âŒ ì—ëŸ¬: ${err.message}</span>`;
            }
        }
        
        // ì¸ì¦ ìƒíƒœ í™•ì¸
        async function testAuth() {
            const result = document.getElementById('auth-result');
            result.innerHTML = 'â³ í™•ì¸ ì¤‘...';
            
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    result.innerHTML = `<span class="error">âŒ ì—ëŸ¬: ${error.message}</span>`;
                } else if (user) {
                    result.innerHTML = 
                        `<span class="success">âœ… ë¡œê·¸ì¸ë¨</span>\n\n` +
                        `User ID: ${user.id}\n` +
                        `Email: ${user.email}\n` +
                        JSON.stringify(user, null, 2);
                } else {
                    result.innerHTML = `<span>â„¹ï¸ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ (ìµëª… ì‚¬ìš©ì)</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span class="error">âŒ ì˜ˆì™¸ ë°œìƒ: ${err.message}</span>`;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í…ŒìŠ¤íŠ¸
        window.onload = async () => {
            await testContestants();
            await testVotes();
            await testVoteCount();
            await testAuth();
        };
    </script>
</body>
</html>

